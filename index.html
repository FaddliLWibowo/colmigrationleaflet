<!DOCTYPE html>
<html lang="en-us">

<head>
    <script type="text/javascript"> var timerStart = Date.now(); </script>
    <meta charset="utf-8" />
    <title>Leaflet Web App</title>
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico" />
    <!-- ____________ CSS Styles __________ -->
    <!-- Leaflet Style Sheet -->
    <link rel="stylesheet" href="css/leaflet.css">
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Edited Styling -->
    <link href="css/main.css" rel="stylesheet"> 
</head>

<body>
    <!-- ##############################################  -->
    <!-- ###########    WEBPAGE ELEMENTS    ###########  -->
    <!-- ##############################################  -->

    <!-- Navbar -->
    <nav class="navbar navbar-default">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Leaflet Web Application</a>
        </div>
        <!--<ul class="nav navbar-nav navbar-right">
            <li><a href="https://cccruzr.github.io/">Camilo Cruz, 2017.</a></li>
        </ul> -->
    </nav>

    
    <!-- Legend -->
    <div class="list-group legend">
        <h4>COLOMBIA INTERNALLY DISPLACED PEOPLE</h4>
        <h6>REPORTED 1985-2015</h6>
        <br/>

        <div class="legend-text" style="height:2px;">
            <div style="width:33.3%; text-align:left; float:left;"><p>ORIGIN</p></div>
            <div style="width:33.3%; text-align:center; float:left;"><p>&rarr;</p></div>
            <div style="width:33.3%; text-align:right; float:left;"><p>DESTINATION</p></div>
        </div>
        <div class="legend-bar">
            <div class="bar-legend" style="height:0.7px;background:#FF7111;"></div>
            <div class="bar-legend" style="height:0.7px;background:#FF944C;"></div>
            <div class="bar-legend" style="height:2px;background:#FFB989;"></div>
            <div class="bar-legend" style="height:2px;background:#FFFFFF;"></div>
            <div class="bar-legend" style="height:3px;background:#EBF6F9;"></div>
            <div class="bar-legend" style="height:4px;background:#D6ECF4;"></div>
            <div class="bar-legend" style="height:5px;background:#C2E3EF;"></div>
            <div class="bar-legend" style="height:6px;background:#ABD9E9;"></div>
        </div>
        <div>
            <div class="legend-num"><p> >2500 </p></div>
            <div class="legend-num"><p></p></div>
            <div class="legend-num"><p> 5000 </p></div>
            <div class="legend-num"><p></p></div>
            <div class="legend-num"><p> 10 000 </p></div>
            <div class="legend-num"><p> 20 000 </p></div>
            <div class="legend-num"><p> 30 000</p></div>
            <div class="legend-num"><p> >40 000 </p></div>
        </div>

        <br><br>
        <!-- Toggle slider -->
        <div id="animationControl">
            <div class="legend-text" style="float: left; color: white"> <p>Toggle Animation &nbsp;&nbsp;<p></div>
            <label class="switch"> 
                <input id="animateToggle" type="checkbox">
                <div class="slider"> </div>
            </label>
        </div>
        <br><br><br>
        <div>
            <div class="legend2 legend-text-m" style="width:50%; line-height: 14px;"><p><br>NUMBER OF<br>PEOPLE AFFECTED<p></div>
            <div class="legend2">
                <svg width="50" height="50">
                    <circle class="circle-legend" cx="25" cy="40" r="7" stroke-dasharray="4,4" />
                    <circle class="circle-legend" cx="25" cy="33" r="14" stroke-dasharray="4,4" />
                    <circle class="circle-legend" cx="25" cy="26" r="21"  stroke-dasharray="4,4" />
                </svg>
            </div>
            <div class="legend2 legend-text-s" style="margin-left: 5px"> <p> >100 000 <br> 50 000 — 100 0000 <br> 10 000 — 50 000<p> </div>
        </div>
            
        
        <br><br><br><br>
        <div class="buttons-panel">
            <select id="munList" class="dropdown-list" onchange="getObjectInArray(munArray)">
                <option value="default" selected disabled hidden>Choose a Municipality</option>
                <option value='5002'>ABEJORRAL</option>
                <option value='50006'>ACACÍAS</option>
                <option value='27006'>ACANDÍ</option>
                <option value='41006'>ACEVEDO</option>
                <option value='13006'>ACHÍ</option>
                <option value='20011'>AGUACHICA</option>
                <option value='20013'>AGUSTÍN CODAZZI</option>
                <option value='41020'>ALGECIRAS</option>
                <option value='13030'>ALTOS DEL ROSARIO</option>
                <option value='5040'>ANORÍ</option>
                <option value='5045'>APARTADÓ</option>
                <option value='47053'>ARACATACA</option>
                <option value='81001'>ARAUCA</option>
                <option value='81065'>ARAUQUITA</option>
                <option value='5051'>ARBOLETES</option>
                <option value='5055'>ARGELIA</option>
                <option value='19050'>ARGELIA</option>
                <option value='63001'>ARMENIA</option>
                <option value='73067'>ATACO</option>
                <option value='23068'>AYAPEL</option>
                <option value='27073'>BAGADÓ</option>
                <option value='19075'>BALBOA</option>
                <option value='52079'>BARBACOAS</option>
                <option value='68081'>BARRANCABERMEJA</option>
                <option value='13074'>BARRANCO DE LOBA</option>
                <option value='8001'>BARRANQUILLA</option>
                <option value='20045'>BECERRIL</option>
                <option value='18094'>BELÉN DE LOS ANDAQUÍES</option>
                <option value='27099'>BELLAVISTA</option>
                <option value='5088'>BELLO</option>
                <option value='27425'>BETÉ</option>
                <option value='5093'>BETULIA</option>
                <option value='52490'>BOCAS DE SATINGA</option>
                <option value='11001'>BOGOTÁ D.C.</option>
                <option value='19100'>BOLÍVAR</option>
                <option value='20060'>BOSCONIA</option>
                <option value='68001'>BUCARAMANGA</option>
                <option value='76109'>BUENAVENTURA</option>
                <option value='19110'>BUENOS AIRES</option>
                <option value='5120'>CÁCERES</option>
                <option value='19130'>CAJIBÍO</option>
                <option value='19142'>CALOTO</option>
                <option value='13160'>CANTAGALLO</option>
                <option value='5147'>CAREPA</option>
                <option value='13001'>CARTAGENA DE INDIAS</option>
                <option value='18150'>CARTAGENA DEL CHAIRÁ</option>
                <option value='5893'>CASABE</option>
                <option value='5154'>CAUCASIA</option>
                <option value='70230'>CHALÁN</option>
                <option value='73168'>CHAPARRAL</option>
                <option value='5172'>CHIGORODÓ</option>
                <option value='20175'>CHIMICHAGUA</option>
                <option value='20178'>CHIRIGUANÁ</option>
                <option value='47170'>CHIVOLO</option>
                <option value='47189'>CIÉNAGA</option>
                <option value='68190'>CIMITARRA</option>
                <option value='5197'>COCORNÁ</option>
                <option value='41206'>COLOMBIA</option>
                <option value='54206'>CONVENCIÓN</option>
                <option value='13212'>CÓRDOBA</option>
                <option value='70215'>COROZAL</option>
                <option value='73217'>COYAIMA</option>
                <option value='54001'>CÚCUTA</option>
                <option value='99773'>CUMARIBO</option>
                <option value='52233'>CUMBITARA</option>
                <option value='27150'>CURBARADÓ</option>
                <option value='18205'>CURILLO</option>
                <option value='20228'>CURUMANÍ</option>
                <option value='5234'>DABEIBA</option>
                <option value='76233'>DAGUA</option>
                <option value='44090'>DIBULLA</option>
                <option value='66170'>DOSQUEBRADAS</option>
                <option value='5250'>EL BAGRE</option>
                <option value='47245'>EL BANCO</option>
                <option value='19532'>EL BORDO</option>
                <option value='54245'>EL CARMEN</option>
                <option value='27245'>EL CARMEN DE ATRATO</option>
                <option value='13244'>EL CARMEN DE BOLÍVAR</option>
                <option value='5148'>EL CARMEN DE VIBORAL</option>
                <option value='50251'>EL CASTILLO</option>
                <option value='52250'>EL CHARCO</option>
                <option value='20238'>EL COPEY</option>
                <option value='18247'>EL DONCELLO</option>
                <option value='18256'>EL PAUJÍL</option>
                <option value='47258'>EL PIÑÓN</option>
                <option value='47268'>EL RETÉN</option>
                <option value='95025'>EL RETORNO</option>
                <option value='19256'>EL TAMBO</option>
                <option value='54250'>EL TARRA</option>
                <option value='18001'>FLORENCIA</option>
                <option value='68276'>FLORIDABLANCA</option>
                <option value='44279'>FONSECA</option>
                <option value='81300'>FORTUL</option>
                <option value='5284'>FRONTINO</option>
                <option value='47288'>FUNDACIÓN</option>
                <option value='25290'>FUSAGASUGÁ</option>
                <option value='41298'>GARZÓN</option>
                <option value='68307'>GIRÓN</option>
                <option value='5313'>GRANADA</option>
                <option value='50313'>GRANADA</option>
                <option value='76111'>GUADALAJARA DE BUGA</option>
                <option value='19318'>GUAPÍ</option>
                <option value='70265'>GUARANDA</option>
                <option value='54344'>HACARÍ</option>
                <option value='73001'>IBAGUÉ</option>
                <option value='52356'>IPIALES</option>
                <option value='52696'>ISCUANDÉ</option>
                <option value='27361'>ISTMINA</option>
                <option value='5360'>ITAGÜÍ</option>
                <option value='5361'>ITUANGO</option>
                <option value='76364'>JAMUNDÍ</option>
                <option value='86865'>LA HORMIGA</option>
                <option value='20400'>LA JAGUA DE IBIRICO</option>
                <option value='50350'>LA MACARENA</option>
                <option value='18410'>LA MONTAÑITA</option>
                <option value='25394'>LA PALMA</option>
                <option value='41396'>LA PLATA</option>
                <option value='5400'>LA UNIÓN</option>
                <option value='19397'>LA VEGA</option>
                <option value='68406'>LEBRIJA</option>
                <option value='50400'>LEJANÍAS</option>
                <option value='73411'>LÍBANO</option>
                <option value='19418'>LÓPEZ</option>
                <option value='70418'>LOS PALMITOS</option>
                <option value='13430'>MAGANGUÉ</option>
                <option value='44430'>MAICAO</option>
                <option value='8433'>MALAMBO</option>
                <option value='17001'>MANIZALES</option>
                <option value='50325'>MAPIRIPÁN</option>
                <option value='13442'>MARÍA LA BAJA</option>
                <option value='5440'>MARINILLA</option>
                <option value='5001'>MEDELLÍN</option>
                <option value='19450'>MERCADERES</option>
                <option value='50330'>MESETAS</option>
                <option value='18460'>MILÁN</option>
                <option value='95200'>MIRAFLORES</option>
                <option value='86001'>MOCOA</option>
                <option value='13458'>MONTECRISTO</option>
                <option value='23466'>MONTELÍBANO</option>
                <option value='23001'>MONTERÍA</option>
                <option value='13473'>MORALES</option>
                <option value='19473'>MORALES</option>
                <option value='5480'>MUTATÁ</option>
                <option value='5483'>NARIÑO</option>
                <option value='73483'>NATAGAIMA</option>
                <option value='5495'>NECHÍ</option>
                <option value='5490'>NECOCLÍ</option>
                <option value='41001'>NEIVA</option>
                <option value='54498'>OCAÑA</option>
                <option value='86320'>ORITO</option>
                <option value='73504'>ORTEGA</option>
                <option value='70508'>OVEJAS</option>
                <option value='20517'>PAILITAS</option>
                <option value='76520'>PALMIRA</option>
                <option value='20550'>PELAYA</option>
                <option value='17541'>PENSILVANIA</option>
                <option value='5543'>PEQUE</option>
                <option value='66001'>PEREIRA</option>
                <option value='19533'>PIAMONTE</option>
                <option value='27025'>PIE DE PATO</option>
                <option value='68547'>PIEDECUESTA</option>
                <option value='41551'>PITALITO</option>
                <option value='47551'>PIVIJAY</option>
                <option value='27077'>PIZARRO</option>
                <option value='73555'>PLANADAS</option>
                <option value='23555'>PLANETA RICA</option>
                <option value='47555'>PLATO</option>
                <option value='52540'>POLICARPA</option>
                <option value='19001'>POPAYÁN</option>
                <option value='47980'>PRADO - SEVILLA</option>
                <option value='20570'>PUEBLO BELLO</option>
                <option value='66572'>PUEBLO RICO</option>
                <option value='86568'>PUERTO ASÍS</option>
                <option value='5579'>PUERTO BERRÍO</option>
                <option value='86569'>PUERTO CAICEDO</option>
                <option value='50450'>PUERTO CONCORDIA</option>
                <option value='86571'>PUERTO GUZMÁN</option>
                <option value='86573'>PUERTO LEGUÍZAMO</option>
                <option value='23580'>PUERTO LIBERTADOR</option>
                <option value='50577'>PUERTO LLERAS</option>
                <option value='13810'>PUERTO RICO</option>
                <option value='18592'>PUERTO RICO</option>
                <option value='50590'>PUERTO RICO</option>
                <option value='68575'>PUERTO WILCHES</option>
                <option value='66594'>QUINCHÍA</option>
                <option value='5604'>REMEDIOS</option>
                <option value='47605'>REMOLINO</option>
                <option value='52612'>RICAURTE</option>
                <option value='70204'>RICAURTE (COLOSO)</option>
                <option value='13600'>RÍO VIEJO</option>
                <option value='73616'>RIOBLANCO</option>
                <option value='44001'>RIOHACHA</option>
                <option value='5615'>RIONEGRO</option>
                <option value='17614'>RIOSUCIO</option>
                <option value='27615'>RIOSUCIO</option>
                <option value='20621'>ROBLES</option>
                <option value='73624'>ROVIRA</option>
                <option value='68655'>SABANA DE TORRES</option>
                <option value='17662'>SAMANÁ</option>
                <option value='52678'>SAMANIEGO</option>
                <option value='47660'>SAN ÁNGEL</option>
                <option value='73675'>SAN ANTONIO</option>
                <option value='70678'>SAN BENITO ABAD</option>
                <option value='54670'>SAN CALIXTO</option>
                <option value='5649'>SAN CARLOS</option>
                <option value='20750'>SAN DIEGO</option>
                <option value='5652'>SAN FRANCISCO</option>
                <option value='27001'>SAN FRANCISCO DE QUIBDO</option>
                <option value='13654'>SAN JACINTO</option>
                <option value='52621'>SAN JOSÉ</option>
                <option value='18610'>SAN JOSÉ DEL FRAGUA</option>
                <option value='95001'>SAN JOSÉ DEL GUAVIARE</option>
                <option value='52001'>SAN JUAN DE PASTO</option>
                <option value='5659'>SAN JUAN DE URABÁ</option>
                <option value='44650'>SAN JUAN DEL CESAR</option>
                <option value='13657'>SAN JUAN NEPOMUCENO</option>
                <option value='5660'>SAN LUIS</option>
                <option value='13667'>SAN MARTÍN DE LOBA</option>
                <option value='86757'>SAN MIGUEL</option>
                <option value='70713'>SAN ONOFRE</option>
                <option value='13670'>SAN PABLO</option>
                <option value='5664'>SAN PEDRO DE LOS MILAGROS</option>
                <option value='5665'>SAN PEDRO DE URABÁ</option>
                <option value='5667'>SAN RAFAEL</option>
                <option value='68689'>SAN VICENTE DE CHUCURÍ</option>
                <option value='18753'>SAN VICENTE DEL CAGUÁN</option>
                <option value='47001'>SANTA MARTA</option>
                <option value='13683'>SANTA ROSA DE LIMA</option>
                <option value='13688'>SANTA ROSA DEL SUR</option>
                <option value='19698'>SANTANDER DE QUILICHAO</option>
                <option value='76001'>SANTIAGO DE CALI</option>
                <option value='81736'>SARAVENA</option>
                <option value='54720'>SARDINATA</option>
                <option value='5736'>SEGOVIA</option>
                <option value='13744'>SIMITÍ</option>
                <option value='70001'>SINCELEJO</option>
                <option value='47745'>SITIONUEVO</option>
                <option value='25754'>SOACHA</option>
                <option value='18756'>SOLANO</option>
                <option value='8758'>SOLEDAD</option>
                <option value='18785'>SOLITA</option>
                <option value='5756'>SONSÓN</option>
                <option value='52418'>SOTOMAYOR</option>
                <option value='19780'>SUÁREZ</option>
                <option value='70771'>SUCRE</option>
                <option value='27787'>TADÓ</option>
                <option value='81794'>TAME</option>
                <option value='52786'>TAMINANGO</option>
                <option value='5790'>TARAZÁ</option>
                <option value='54800'>TEORAMA</option>
                <option value='54810'>TIBÚ</option>
                <option value='23807'>TIERRALTA</option>
                <option value='19809'>TIMBIQUÍ</option>
                <option value='70823'>TOLÚ VIEJO</option>
                <option value='19821'>TORIBÍO</option>
                <option value='76834'>TULUÁ</option>
                <option value='52835'>TUMACO</option>
                <option value='5837'>TURBO</option>
                <option value='27800'>UNGUÍA</option>
                <option value='5847'>URRAO</option>
                <option value='5854'>VALDIVIA</option>
                <option value='23855'>VALENCIA</option>
                <option value='20001'>VALLEDUPAR</option>
                <option value='18860'>VALPARAÍSO</option>
                <option value='5873'>VIGÍA DEL FUERTE</option>
                <option value='86885'>VILLAGARZÓN</option>
                <option value='44874'>VILLANUEVA</option>
                <option value='50001'>VILLAVICENCIO</option>
                <option value='25878'>VIOTÁ</option>
                <option value='50711'>VISTAHERMOSA</option>
                <option value='5887'>YARUMAL</option>
                <option value='85001'>YOPAL</option>
                <option value='13894'>ZAMBRANO</option>
                <option value='5895'>ZARAGOZA</option>
            </select> 
            <button class="btn btn-warning btn-xs" id="button-all">ALL</button>
            <button class="btn btn-default btn-xs" id="button-in">INWARDS</button>
            <button class="btn btn-default btn-xs" id="button-out">OUTWARDS</button>
        </div>
        <br><br>
        <div id="selWarning">
            <p class="text-warning">Select a municipality from the list or by clicking the map.</p>
        </div>


    </div>

    <!-- Map container -->
     <div id="map"></div>
    



    <!-- Line gradient style for paths -->
    <svg id="svg-rules">
        <defs>
            <linearGradient id="E" x1="0" x2="1" y1="0" y2="0">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                    <animate attributeName="" dur="3s" values="0;1.5"
                        repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="NE" x1="0" x2="1" y1="1" y2="0">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="N" x1="0" x2="1" y1="1" y2="0">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="NW" x1="1" x2="0" y1="1" y2="0">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="W" x1="1" x2="0" y1="0" y2="0">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="SW" x1="1" x2="0" y1="0" y2="1">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="S" x1="1" x2="1" y1="0" y2="1">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>

            <linearGradient id="SE" x1="0" x2="1" y1="0" y2="1">
                <stop offset="5%" stop-color="#FF7111"/>
                <stop class="offset50" offset="50%" stop-color="white" stop-opacity="0.25">
                <animate attributeName="" dur="3s" values="0;1.5"
                    repeatCount="indefinite" />
                </stop>
                <stop offset="95%" stop-color="#abd9e9"/>
            </linearGradient>
        </defs>
    </svg>  
    

    <!-- ########################################  -->
    <!-- ###########    JAVASCRIPT    ###########  -->
    <!-- ########################################  -->

    <!-- ___________ LOADING OF REQUIRED LIBRARIES ___________  -->
   
    <!-- Leaflet library -->
    <script src="js/leaflet.js"></script>
    <!-- jQuery -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <!-- Bootstrap script
    <script src="js/bootstrap.min.js"></script> -->
    <!-- Esri Leaflet it has no .css stylesheet of its own, only .js -->
    <script src="js/esri-leaflet.js"></script>
    <!-- Leaflet Omnivore - Data conversion -->
    <script src='js/leaflet-omnivore.min.js'></script>
    <!-- D3 -->
    <script src="js/d3.v3.min.js"></script>
    <!-- jquery-csv -->
    <script src="js/svg-anim-opt.js"></script>
    <!-- jquery-csv -->
    <script src="js/jquery.csv.min.js"></script>

    
    <!-- ___________ END OF LIBRARIES LOADING ___________  -->

    <script type="text/javascript">
        //START: Basemap Tiles creation
        var OSMLink = '<a href="http://openstreetmap.org">&copy;OpenStreetMap</a>',
            RNVLink = '<a href="http://rni.unidadvictimas.gov.co/RUV">Registro Único de Víctimas</a>',
            C4SRLink = '<a href="http://http://c4sr.columbia.edu">Center for Spatial Research</a>';

        //Carto DarkMatter tiles attribution and URL
        var cartoLink = '<a href="http://cartodb.com/attributions">&copy;CartoDB</a>',
        	cartoURL = 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
        	cartoAttrib = RNVLink + ' | ' + C4SRLink + ' | ' + OSMLink + ' | ' + cartoLink;

        //Carto DarkMatter NOLABELS tiles attribution and URL
        var cartoURL_NL = 'http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png';

        var cartoMap = L.tileLayer(cartoURL, {
            attribution: cartoAttrib
        });
        var cartoMap_NL = L.tileLayer(cartoURL_NL, {
            attribution: cartoAttrib
        });
        var esriDarkGray = L.esri.basemapLayer('DarkGray', {
            attribution: RNVLink,
        });
        //END
        //Map creation centered in Bogota
        var bounds = new L.latLngBounds(       //Map boundaries
        	L.latLng(17, -95),     //UpperLeft 
        	L.latLng(-8, -54)    //BottomRight
        );
        var map = L.map('map', {
            layers: [cartoMap_NL], //InitialLayer
            maxBounds: bounds,
            maxBoundsViscosity: 0.8,
            minZoom: 6,	//Maximum zoom out
            maxZoom: 11,  //Maximum zoom in
            zoomControl: false,
        }).setView([4.7110, -74.0721], 6);

        //Base layers definition
        var baseLayers = {
            "Esri Dark Gray": esriDarkGray,
            "DarkMatter (No Labels)": cartoMap_NL,
            "DarkMatter": cartoMap,
        };

        //Base layers addition
        L.control.layers(baseLayers).addTo(map);
        L.control.zoom({position: 'bottomright'}).addTo(map);

        // Disable zoom on double click
        map.doubleClickZoom.disable();

        //Redefine double click to reset path display
        map.on("dblclick", function(event){
            resetPath();
        });

        // START ------------- Municipalities Layer
        var munCustomLayer = null;

        munCustomLayer = L.geoJson(null, {
            onEachFeature: showAll,

            filter: function (feature, layer) {
                 return feature.properties.TotalImpct > 10000;
            },
            pointToLayer: function(feature, latlng) { //Style the layer based on TotalImpact
                if (feature.properties.TotalImpct < 50000){
                    return new L.CircleMarker(latlng, {
                        radius: 5,
                        color: "#e0e0e0",
                        opacity: 0.85,
                        weight: 1.6,
                        dashArray: "2,2",
                        fillOpacity: 0.01,
                    });    
                };
                if (feature.properties.TotalImpct > 50000 && feature.properties.TotalImpct < 100000 ){
                    return new L.CircleMarker(latlng, {
                        radius: 10,
                        color: "#e0e0e0",
                        opacity: 0.85,
                        weight: 1.6,
                        dashArray: "3,3",
                        fillOpacity: 0.01,
                    });    
                };
                if (feature.properties.TotalImpct > 100000 ){
                    return new L.CircleMarker(latlng, {
                        radius: 15,
                        color: "#e0e0e0",
                        opacity: 0.85,
                        weight: 1.6,
                        dashArray: "3,3",
                        fillOpacity: 0.01,
                    });    
                };
                
            },
        });
         //Omnivore CSV import and addition to map
        omnivore.csv('data/Municipios_Resumen_num.csv', null, munCustomLayer).addTo(map);
        // END -------------- Municipalities Layer
        
        // START ------- Line paths
        var pathsLayer = null;
        $.getJSON("data/displacement.geojson", function(data){
            // set pathsLayer to GeoJSON, add GeoJSON layer to the map once the file is loaded
            pathsLayer = L.geoJson(data,{
                className: 'polyline',
                interactive: false,
                style: function (feature) {
                    var dirLon = feature.properties.DestLon - feature.properties.OrgLon;
                    var dirLat = feature.properties.DestLat - feature.properties.OrgLat;
                    var direction = getLineDirection(dirLon, dirLat);
                    //console.log(dirLon, dirLat, direction);
                    feature.properties["stroke"] = "url(#" + direction + ")";

                    return {
                        className: "linePath D" + feature.properties.Dest + " O" + feature.properties.Origin + " " + feature.properties.stroke,
                        weight: getLineWeight(feature.properties.Count),
                        color: feature.properties.stroke,
                    };
                },
            }).addTo(map);
        });
        // END --- Line paths
        
        // Actions after AJAX requests complete
        $( document ).ajaxComplete(function() {
            munCustomLayer.bringToFront();
        });

        // Initially hide the paths buttons
        showHidePathButtons();
        // GLOBAL VARIABLES: Selected Municipality
        var selectedMun = null,
            selectedLat = null,
            selectedLng = null;
            selectedCoords = null;

  
        /* FUNCTIONS */
        // Calculate the line weight based on # of affected people
        function getLineWeight(c) {
            return  c > 40000  ? 6 :
                    c > 30000  ? 5 :
                    c > 20000  ? 4 :
                    c > 10000  ? 3 :
                    c > 5000   ? 2 :
                    c > 2500   ? 0.7 :
                    c > 1000   ? 0.4 :
                                 0.2;
        };

        // Calculate line direction
        function getLineDirection(lng, lat){
            var deg = Math.atan2(lat, lng) * 180 / Math.PI;
            var angle;
            if (deg < 0) { angle = deg + 360 }
            else         { angle = deg };
            //console.log(angle);
            return  angle < 22.5    ? "E"  :
                    angle < 67.5    ? "NE" :
                    angle < 112.5   ? "N"  :
                    angle < 157.5   ? "NW" :
                    angle < 202.5   ? "W"  :
                    angle < 247.5   ? "SW" :
                    angle < 292.5   ? "S"  :
                    angle < 337.5   ? "SE" :
                                      "E";
        };

     // Hide all paths
        function hideAll(){
            d3.selectAll(".linePath") //Hide all linePaths
                    .attr("stroke-opacity", 0);
        };

        // Show individual municipality
        function showAll(feature, layer){
            layer.on('click', function(event) {
                var originClass = ".O" + parseInt(feature.properties.DPNP),
                    destinyClass = ".D" + parseInt(feature.properties.DPNP);
                
                selectedMun = parseInt(feature.properties.DPNP);
                selectedCoords = event.latlng;
                selectedLat = selectedCoords.lat;
                selectedLng = selectedCoords.lng;
                //console.log(selectedMun, selectedLat, selectedLng);
                panToSelectedMun();
                showHidePathButtons();
                showAllPaths();

                hideAll();
                //Show municipality linePaths
                d3.selectAll(originClass +"," + destinyClass) 
                    .attr("stroke-opacity", 1);
                //Change dropdown list value
                $("#munList").val(selectedMun);
            });
        };

        // Pan/Zoom to selected municipality
        function panToSelectedMun(){
            map.panTo(selectedCoords, {
                animate: true,
                duration: 1,
            });
        };

        // Reset default view on double click: show all linePaths
        function resetPath(){
            selectedMun = null;
            showHidePathButtons();
            showAllPaths();
            d3.selectAll(".linePath") 
                .attr("stroke-opacity", 1);
        };

        // Show paths going outside Municipality
        function showOutPaths(){
            var outQuery = ".O" + selectedMun;
            hideAll();
            console.log(selectedMun, outQuery);
            d3.selectAll(outQuery) 
                .attr("stroke-opacity", 1);
            d3.select("#button-out")
                .classed({
                    "btn-warning": true,
                    "btn-default": false,
                });
            d3.selectAll("#button-in, #button-all")
                .classed({
                    "btn-warning": false,
                    "btn-default": true,
                });
        };

        // Show paths going inside Municipality
        function showInPaths(){
            var inQuery = ".D" + selectedMun;
            hideAll();
            console.log(selectedMun, inQuery);
            d3.selectAll(inQuery) 
                .attr("stroke-opacity", 1);

            d3.select("#button-in")
                .classed({
                    "btn-warning": true,
                    "btn-default": false,
                });
            d3.selectAll("#button-out, #button-all")
                .classed({
                    "btn-warning": false,
                    "btn-default": true,
                });
        };

        // Show all paths going in/out Municipality
        function showAllPaths(){
            var allQuery = ".D" + selectedMun + ", .O" + selectedMun;
            hideAll();
            console.log(selectedMun, allQuery);
            d3.selectAll(allQuery) 
                .attr("stroke-opacity", 1);
            d3.select("#button-all")
                .classed({
                    "btn-warning": true,
                    "btn-default": false,
                });
            d3.selectAll("#button-out, #button-in")
                .classed({
                    "btn-warning": false,
                    "btn-default": true,
                });
        };

        // Show/Hide buttons controlling the path's display
        function showHidePathButtons(){
           if(selectedMun == null){
                d3.selectAll(".btn")
                    .style("display","none");
            }
            else{
                d3.selectAll(".btn")
                    .style("display","inline");
                d3.select("#selWarning")
                    .style("display","none");
            }; 
        };

        function munFromList(){
            selectedMun = $("#munList").val();
            panToSelectedMun();
            showAll();
        };

        /* PATHS BUTTONS */
        $("#button-out").click(showOutPaths);
        $("#button-in") .click(showInPaths);
        $("#button-all").click(showAllPaths);

        // Toggle animation checkbox
        $( '#animateToggle' ).change(function(){
            if ($( '#animateToggle' ).prop('checked')){
                d3.selectAll("animate")
                    .attr("attributeName", "offset");
            }
            else {
                d3.selectAll("animate")
                    .attr("attributeName", "");
            }  
        });

        var munArray;
        $.ajax({
            url: "data/Municipios_Resumen_num.csv",
            async: true,
            success: function (csvd) {
                munArray = $.csv.toObjects(csvd);
            },
            dataType: "text",
            complete: function(){console.log("CSV loaded in", Date.now()-timerStart, "ms")},
        });

        function showAllList(){
            panToSelectedMun();
            showHidePathButtons();
            showAllPaths();

            hideAll();
            //Show municipality linePaths
            var originClass = ".O" + selectedMun,
                destinyClass = ".D" + selectedMun;
            d3.selectAll(originClass +"," + destinyClass) 
                .attr("stroke-opacity", 1);
        };

        function getObjectInArray(array) {
            selectedMun = parseInt($("#munList").val());    
            for (var i = 0; i < array.length; i++) {
                if (parseInt(array[i].DPNP) === selectedMun){
                    selectedLat = array[i].latitude;
                    selectedLng = array[i].longitude;
                    selectedCoords = new L.latLng(array[i].latitude, array[i].longitude);
                }
            }
            showAllList();
            panToSelectedMun();
        };



        
        
    </script>
</body>

</html>